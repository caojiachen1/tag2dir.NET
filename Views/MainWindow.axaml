<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:tag2dir.NET.ViewModels"
        xmlns:models="using:tag2dir.NET.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="using:FluentAvalonia.UI.Controls"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="tag2dir.NET.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="tag2dir.NET - å›¾ç‰‡äººç‰©åˆ†ç±»å·¥å…·"
        WindowState="Maximized"
        MinWidth="900" MinHeight="600"
        Width="1200" Height="800">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto,Auto">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <Border Grid.Row="0" 
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,0,0,1"
                Padding="16">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*">
                <!-- æºæ–‡ä»¶å¤¹ -->
                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,8">
                    <TextBlock Text="æºæ–‡ä»¶å¤¹" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox Grid.Column="0" 
                                 Text="{Binding SourceFolder, Mode=TwoWay}" 
                                 Watermark="é€‰æ‹©åŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹..."
                                 IsReadOnly="True"/>
                        <Button Grid.Column="1" 
                                Content="æµè§ˆ..." 
                                Command="{Binding BrowseSourceFolderCommand}"
                                Margin="8,0,0,0"/>
                    </Grid>
                </StackPanel>

                <!-- ç›®æ ‡æ–‡ä»¶å¤¹ -->
                <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,8">
                    <TextBlock Text="ç›®æ ‡æ–‡ä»¶å¤¹" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox Grid.Column="0" 
                                 Text="{Binding DestinationFolder, Mode=TwoWay}" 
                                 Watermark="é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹..."
                                 IsReadOnly="True"/>
                        <Button Grid.Column="1" 
                                Content="æµè§ˆ..." 
                                Command="{Binding BrowseDestinationFolderCommand}"
                                Margin="8,0,0,0"/>
                    </Grid>
                </StackPanel>

                <!-- æ“ä½œæŒ‰é’® -->
                <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" 
                            Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding ScanCommand}"
                            IsVisible="{Binding !IsScanning}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:FAPathIcon Data="M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A7.952 7.952 0 0 0 18 10c0-4.411-3.589-8-8-8s-8 3.589-8 8 3.589 8 8 8zm0-14c3.309 0 6 2.691 6 6s-2.691 6-6 6-6-2.691-6-6 2.691-6 6-6z" Width="16" Height="16"/>
                            <TextBlock Text="æ‰«æå›¾ç‰‡"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding CancelScanCommand}"
                            IsVisible="{Binding IsScanning}"
                            Background="{DynamicResource SystemFillColorCautionBackgroundBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:FAPathIcon Data="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z" Width="16" Height="16"/>
                            <TextBlock Text="å–æ¶ˆæ‰«æ"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding PreviewMoveCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:FAPathIcon Data="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" Width="16" Height="16"/>
                            <TextBlock Text="é¢„è§ˆç§»åŠ¨"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding MoveFilesCommand}"
                            Classes="accent">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:FAPathIcon Data="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10zm-8-4l4-4h-3V6h-2v4H8l4 4z" Width="16" Height="16"/>
                            <TextBlock Text="æ‰§è¡Œç§»åŠ¨"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding UndoMoveCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:FAPathIcon Data="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" Width="16" Height="16"/>
                            <TextBlock Text="æ’¤é”€ç§»åŠ¨"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding ToggleSelectAllCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:FAPathIcon Data="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2zM7 17h10V7H7v10zm2-8h6v6H9V9z" Width="16" Height="16"/>
                            <TextBlock Text="å…¨é€‰/å–æ¶ˆ"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ä¸»å†…å®¹åŒº -->
        <Grid Grid.Row="1">
            <!-- å›¾ç‰‡ç½‘æ ¼ -->
            <Border Margin="16,16,16,16">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock Grid.Row="0" 
                               Text="{Binding ScanProgressText}" 
                               IsVisible="{Binding IsScanning}"
                               Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"
                               Margin="0,0,0,8"/>
                    
                    <!-- ExifTool è­¦å‘Š -->
                    <ui:InfoBar Grid.Row="0"
                                IsOpen="{Binding !HasExifTool}"
                                Severity="Warning"
                                Title="ExifTool æœªå®‰è£…"
                                Message="è¯·å®‰è£… ExifTool (https://exiftool.org/) å¹¶å°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH"
                                Margin="0,0,0,8"/>

                    <!-- ä½¿ç”¨ ScrollViewer + ItemsControl å®žçŽ°ç½‘æ ¼ï¼ˆä¸å¯é€‰ä¸­ï¼‰ -->
                    <ScrollViewer Grid.Row="1"
                                  x:Name="ImagesScrollViewer"
                                  HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding Images}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="models:ImageInfo">
                                    <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                            BorderThickness="1"
                                            CornerRadius="8"
                                            Padding="8"
                                            Width="220"
                                            Height="380"
                                            Margin="6"
                                            ClipToBounds="True">
                                        <Grid RowDefinitions="Auto,180,Auto,Auto,Auto">
                                            <!-- é€‰æ‹©æ¡† + æ–‡ä»¶å -->
                                            <Grid Grid.Row="0" ColumnDefinitions="Auto,*" Margin="0,0,0,8">
                                                <CheckBox Grid.Column="0" 
                                                          IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                          VerticalAlignment="Center"/>
                                                <TextBlock Grid.Column="1" 
                                                           Text="{Binding FileName}"
                                                           FontWeight="SemiBold"
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center"
                                                           Margin="4,0,0,0"
                                                           ToolTip.Tip="{Binding FileName}"/>
                                            </Grid>
                                            
                                            <!-- ç¼©ç•¥å›¾ï¼ˆç«–å¹…æ¯”ä¾‹ï¼Œæ¨ªå¹…å›¾ç‰‡ä¸Šä¸‹ç•™ç™½ï¼‰ -->
                                            <Border Grid.Row="1"
                                                    CornerRadius="6"
                                                    ClipToBounds="True"
                                                    Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                                                    Height="180">
                                                <Image Source="{Binding Thumbnail}"
                                                       Stretch="Uniform"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                            </Border>
                                            
                                            <!-- äººç‰©ä¿¡æ¯ -->
                                            <StackPanel Grid.Row="2" Margin="0,8,0,0">
                                                <TextBlock Text="äººç‰©:" 
                                                           FontSize="11" 
                                                           Opacity="0.6"/>
                                                <TextBlock Text="{Binding PeopleDisplay}"
                                                           FontSize="12"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip.Tip="{Binding PeopleDisplay}"/>
                                            </StackPanel>
                                            
                                            <!-- ç›®æ ‡äººç‰©é€‰æ‹© -->
                                            <StackPanel Grid.Row="3" Margin="0,4,0,0">
                                                <TextBlock Text="ç§»åŠ¨åˆ°:" 
                                                           FontSize="11" 
                                                           Opacity="0.6"/>
                                                <ComboBox ItemsSource="{Binding People}"
                                                          SelectedItem="{Binding SelectedPerson, Mode=TwoWay}"
                                                          HorizontalAlignment="Stretch"
                                                          Margin="0,2,0,0"/>
                                            </StackPanel>
                                            
                                            <!-- æ ‡ç­¾ -->
                                            <TextBlock Grid.Row="4"
                                                       Text="{Binding TagsDisplay}"
                                                       FontSize="10"
                                                       Opacity="0.5"
                                                       TextTrimming="CharacterEllipsis"
                                                       Margin="0,4,0,0"
                                                       ToolTip.Tip="{Binding TagsDisplay}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- åº•éƒ¨é¢„è§ˆé¢æ¿ï¼ˆå¯å…³é—­ï¼‰ -->
        <Border Grid.Row="2" 
                Height="350"
                IsVisible="{Binding ShowPreview}"
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,12">
            <Grid RowDefinitions="Auto,*">
                <!-- æ ‡é¢˜æ å’Œå…³é—­æŒ‰é’® -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                        <TextBlock Text="ðŸ“‹ ç§»åŠ¨é¢„è§ˆ" 
                                   FontWeight="Bold" 
                                   FontSize="18"
                                   VerticalAlignment="Center"/>
                        <Border Background="{DynamicResource AccentFillColorDefaultBrush}"
                                CornerRadius="12"
                                Padding="12,4">
                            <TextBlock Text="{Binding MovePreview.Count, StringFormat='{}{0} ä¸ªæ–‡ä»¶'}"
                                       FontSize="12"
                                       Foreground="White"
                                       VerticalAlignment="Center"/>
                        </Border>
                        <Border Background="{DynamicResource SystemFillColorSuccessBackgroundBrush}"
                                CornerRadius="12"
                                Padding="12,4">
                            <TextBlock Text="{Binding GroupedMovePreview.Count, StringFormat='{}{0} ä¸ªäººç‰©æ–‡ä»¶å¤¹'}"
                                       FontSize="12"
                                       VerticalAlignment="Center"/>
                        </Border>
                    </StackPanel>
                    <Button Grid.Column="1" 
                            Command="{Binding ClosePreviewCommand}"
                            Background="Transparent"
                            Padding="8,4"
                            ToolTip.Tip="å…³é—­é¢„è§ˆ">
                        <ui:FAPathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" 
                                       Width="16" Height="16"/>
                    </Button>
                </Grid>
                
                <!-- æŒ‰äººç‰©åˆ†ç»„çš„é¢„è§ˆåˆ—è¡¨ï¼ˆçº¯ä¸Šä¸‹æ»šåŠ¨ï¼‰ -->
                <ScrollViewer Grid.Row="1"
                              x:Name="PreviewScrollViewer"
                              HorizontalScrollBarVisibility="Disabled"
                              VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding GroupedMovePreview}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical" Spacing="12"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="models:PersonMoveGroup">
                                <Border Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                                        CornerRadius="8"
                                        Padding="12">
                                    <Grid ColumnDefinitions="Auto,*">
                                        <!-- å·¦ä¾§ï¼šäººç‰©ä¿¡æ¯ -->
                                        <StackPanel Grid.Column="0" Width="200" Margin="0,0,16,0">
                                            <!-- äººç‰©åç§°å’Œå¤´åƒ -->
                                            <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,0,0,8">
                                                <Border Background="{DynamicResource AccentFillColorDefaultBrush}"
                                                        CornerRadius="18"
                                                        Width="36" Height="36">
                                                    <TextBlock Text="{Binding PersonName[0]}"
                                                               FontSize="16"
                                                               FontWeight="Bold"
                                                               Foreground="White"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding PersonName}" 
                                                               FontWeight="Bold"
                                                               FontSize="14"/>
                                                    <TextBlock Text="{Binding Records.Count, StringFormat='{}{0} ä¸ªæ–‡ä»¶'}"
                                                               FontSize="11"
                                                               Opacity="0.7"/>
                                                </StackPanel>
                                            </StackPanel>
                                            
                                            <!-- ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ -->
                                            <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                                    CornerRadius="4"
                                                    Padding="8,4">
                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                    <ui:FAPathIcon Data="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" 
                                                                   Width="12" Height="12"
                                                                   Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                    <TextBlock Text="{Binding TargetFolder}"
                                                               FontSize="10"
                                                               TextTrimming="CharacterEllipsis"
                                                               Opacity="0.8"
                                                               MaxWidth="160"
                                                               ToolTip.Tip="{Binding TargetFolder}"/>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>
                                        
                                        <!-- å³ä¾§ï¼šè¯¥äººç‰©çš„å›¾ç‰‡ç¼©ç•¥å›¾åˆ—è¡¨ï¼ˆä½¿ç”¨ WrapPanel è‡ªåŠ¨æ¢è¡Œï¼‰ -->
                                        <ItemsControl Grid.Column="1" ItemsSource="{Binding Records}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:MoveRecord">
                                                    <Border CornerRadius="4" 
                                                            ClipToBounds="True"
                                                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                                            Width="60" Height="60"
                                                            Margin="2"
                                                            ToolTip.Tip="{Binding FileName}">
                                                        <Image Source="{Binding Thumbnail}"
                                                               Stretch="Uniform"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <Border Grid.Row="3" 
                Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" 
                           Text="{Binding StatusMessage}"
                           VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                    <Button Click="ScrollToTop_Click" ToolTip.Tip="æ»šåŠ¨åˆ°å›¾ç‰‡åˆ—è¡¨é¡¶éƒ¨" Padding="8,4">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <ui:FAPathIcon Data="M7 14l5-5 5 5H7z" Width="12" Height="12"/>
                            <TextBlock Text="é¡¶éƒ¨" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Click="ScrollToBottom_Click" ToolTip.Tip="æ»šåŠ¨åˆ°å›¾ç‰‡åˆ—è¡¨åº•éƒ¨" Padding="8,4">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <ui:FAPathIcon Data="M7 10l5 5 5-5H7z" Width="12" Height="12"/>
                            <TextBlock Text="åº•éƒ¨" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <TextBlock Text="{Binding Images.Count, StringFormat='å›¾ç‰‡: {0}'}"
                               VerticalAlignment="Center"
                               Opacity="0.7"/>
                    <TextBlock Text="{Binding PeopleCount, StringFormat='äººç‰©: {0}'}"
                               VerticalAlignment="Center"
                               Opacity="0.7"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>

